<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victoria Clinic Appointments</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .header-bg {
            background-color: #ffd700;
            background-image: linear-gradient(to right, #ffd700, #ffeb3b);
        }
        .header-bg-dark {
            background-color: #007bff;
        }
        .text-dark-blue {
            color: #1a237e;
        }
        .logo-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
        }
        .filter-btn.active {
            @apply bg-blue-600 text-white;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            line-height: 1rem;
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 150ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
        .deletion-column {
            display: none;
        }
        .deletion-mode .deletion-column {
            display: table-cell;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        .edit-info-btn {
            background-color: #1c7ed6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            line-height: 1rem;
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-duration: 150ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .edit-info-btn:hover {
            background-color: #1971c2;
        }
        .calendar-cell {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
            position: relative;
        }
        .calendar-cell:hover {
            background-color: #f7fafc;
        }
        .calendar-cell.has-appointments {
            background-color: #dbeafe;
            font-weight: bold;
        }
        .calendar-cell.has-appointments:hover {
            background-color: #bfdbfe;
        }
        .calendar-cell.current-day {
            background-color: #fde68a;
        }
        .calendar-cell.selected-day {
            background-color: #3b82f6;
            color: white;
        }
        .calendar-cell.selected-day:hover {
            background-color: #2563eb;
        }
        .calendar-count {
            position: absolute;
            top: 4px;
            right: 4px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .service-name {
            cursor: pointer;
            color: #1c7ed6;
            text-decoration: underline;
        }

         /* Print-specific styles */
        @media print {
            body {
                background-color: #fff !important;
                font-size: 10pt; /* Smaller font for printing */
            }
            
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .table-container {
                overflow-x: visible;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
            }
            th, td {
                border: 1px solid #333; /* Darker border for print */
                padding: 6px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2; /* Light gray header for table */
            }
            
            /* Remove link styling */
            a {
                text-decoration: none !important;
                color: inherit !important;
            }

            @page {
                size: landscape;
                margin: 0.5in; /* Reduce margin */
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <header class="w-full header-bg shadow-lg">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="../pictures/CHO LOGO.png" class="rounded-full w-20 h-20 shadow-lg">
                <div class="flex flex-col">
                    <h1 class="text-xl md:text-2xl font-bold text-dark-blue">CITY HEALTH OFFICE</h1>
                    <h2 class="text-lg md:text-xl font-medium text-dark-blue">Victoria Health Center Appointments</h2>
                </div>
            </div>
            <!-- Back button to return to the main dashboard -->
            <a href="../admin-cityhealthmuntinlupa2025-2026-colegio_de_muntinlupa.html" class="bg-gray-700 text-white px-4 py-2 rounded-full font-semibold hover:bg-gray-800 transition">Back to Centers</a>
        </div>
        <div class="w-full h-2 header-bg-dark"></div>
    </header>

    <!-- Approved Patient Count Div -->
    <div class="w-full bg-white shadow-md rounded-md p-4 mt-6 text-center font-bold text-lg text-gray-800 max-w-7xl mx-auto">
        Approved Clients this Month: <span id="totalPatientCount">0</span>
    </div>

    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- Patient Count and Search/Filter Section -->
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-2 mb-6 controls">
            <div class="flex items-center space-x-2">
                <!-- Count moved into a dedicated section -->
            </div>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full md:w-1/2">
                <div class="relative w-full">
                    <input id="searchInput" type="text" placeholder="Search by name or service..." class="w-full px-4 py-2 pl-10 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </div>
                </div>
                <div class="relative w-full">
                    <input id="dateInput" type="date" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>
            <div class="flex space-x-2 w-full md:w-auto">
                <button id="filterAllBtn" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-600 transition w-full md:w-auto active">All</button>
                <button id="filterApprovedBtn" class="filter-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-full font-semibold hover:bg-gray-400 transition w-full md:w-auto">Approved</button>
                <button id="filterDeclinedBtn" class="filter-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-full font-semibold hover:bg-gray-400 transition w-full md:w-auto">Declined</button>
                <button id="viewServiceTotalsBtn" class="bg-purple-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-purple-600 transition w-full md:w-auto">View Service Totals</button>
            </div>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto ml-auto items-center">
                <button id="toggleDeletionBtn" class="bg-red-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-600 transition">Manage Deletions</button>
                <button id="deleteSelectedBtn" class="delete-btn px-6 py-2 rounded-full font-semibold opacity-50 cursor-not-allowed transition hidden" disabled>Delete Selected</button>
            </div>
        </div>

        <!-- Calendar View Section -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="px-3 py-1 bg-gray-200 rounded-full hover:bg-gray-300 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h2 id="currentMonthYear" class="text-xl font-bold"></h2>
                <button id="nextMonthBtn" class="px-3 py-1 bg-gray-200 rounded-full hover:bg-gray-300 transition">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10l-3.293-3.293a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 text-center text-sm">
                <div class="py-2 font-semibold text-gray-500">Sun</div>
                <div class="py-2 font-semibold text-gray-500">Mon</div>
                <div class="py-2 font-semibold text-gray-500">Tue</div>
                <div class="py-2 font-semibold text-gray-500">Wed</div>
                <div class="py-2 font-semibold text-gray-500">Thu</div>
                <div class="py-2 font-semibold text-gray-500">Fri</div>
                <div class="py-2 font-semibold text-gray-500">Sat</div>
            </div>
            <div class="mt-4 text-center print-btn">
                <button id="printBtn" class="bg-gray-700 text-white px-6 py-2 rounded-full font-semibold hover:bg-gray-800 transition">Print / Download Appointments</button>
            </div>
        </div>

        <!-- Warning message for double bookings -->
        <div id="doubleBookingWarning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">Warning!</strong>
            <span class="block sm:inline" id="warningText"></span>
        </div>

        <!-- Appointment Data Table -->
        <div class="table-container bg-white shadow-md rounded-lg">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr class="bg-gray-100 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">
                        <th class="px-5 py-3 border-b-2 border-gray-200 w-10 text-center deletion-column">
                            <input type="checkbox" id="selectAllCheckbox">
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Date</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Time</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Last Name</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">First Name</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Middle Name</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Address</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Service</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Phone</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Email</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200">Specific Details</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 text-center">Status</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 text-center">Action</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 text-center">Edit Info</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 text-center deletion-column">
                            Trash
                        </th>
                    </tr>
                </thead>
                <tbody id="appointmentsTableBody" class="text-sm">
                    <!-- Data will be dynamically inserted here by JavaScript -->
                    <tr><td colspan="15" class="px-5 py-5 text-center text-gray-500">Authenticating...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer class="w-full header-bg mt-12 border-t-4 border-blue-400">
        <div class="container mx-auto py-4 text-center text-gray-800 font-medium">
            MUNTINLUPA CITY HEALTH OFFICE
        </div>
    </footer>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Patient Information</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="editForm">
                        <input type="hidden" id="editKey">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">Last Name</label>
                        <input type="text" id="editLastName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">First Name</label>
                        <input type="text" id="editFirstName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">Middle Name</label>
                        <input type="text" id="editMiddleName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">Address</label>
                        <input type="text" id="editAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">Service</label>
                        <input type="text" id="editService" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">Phone</label>
                        <input type="text" id="editPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveEditBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Save
                    </button>
                    <button id="closeEditModalBtn" class="mt-2 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Service Count Modal -->
    <div id="serviceCountModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="serviceCountTitle" class="text-lg leading-6 font-medium text-gray-900">Total Approved Clients per Service</h3>
                <div id="serviceListContainer" class="mt-4 text-left px-7 py-3 max-h-80 overflow-y-auto">
                    <!-- Service list will be injected here dynamically -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeServiceCountModalBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoBZyS0BKZe1MMG78WpiK9tFQAZBd-wKg",
            authDomain: "cho-clinic.firebaseapp.com",
            databaseURL: "https://cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cho-clinic",
            storageBucket: "cho-clinic.appspot.com",
            messagingSenderId: "1078609107976",
            appId: "1:1078609107976:web:11cfb6afccf463fc17c5bd",
            measurementId: "G-FHE4TNMD0X"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Function to handle authentication
        const authenticateUser = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };

        // This is the core security check.
        // The rest of the script will only run if the user is authenticated.
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is authenticated, proceed to load page content.
                console.log("User is authenticated. Loading appointment data for Victoria clinic.");
                
                // --- ALL PAGE LOGIC IS SAFELY CONTAINED WITHIN THIS BLOCK ---

                // Define a global variable to hold the fetched appointments
                let allAppointments = [];
                let currentFilter = 'All';
                let confirmTimeout = null;
                let confirmingButton = null;

                // Calendar variables
                let currentYear, currentMonth;
                const today = new Date();

                // Function to update the patient counts
                function updateCounts(data, year, month) {
                    const totalPatientCountEl = document.getElementById('totalPatientCount');
                    
                    if (!data) {
                        totalPatientCountEl.textContent = '0';
                        updateCalendar({});
                        return;
                    }

                    const appointmentsArray = Object.values(data);
                    
                    // Filter appointments for the current calendar month that are also 'Approved'
                    const approvedAppointmentsInMonth = appointmentsArray.filter(appointment => {
                        const appointmentDate = new Date(appointment.preferredDate);
                        const apptYear = appointmentDate.getFullYear();
                        const apptMonth = appointmentDate.getMonth();
                        return apptYear === year && apptMonth === month && appointment.status === 'Approved';
                    });

                    const totalCount = approvedAppointmentsInMonth.length;
                    totalPatientCountEl.textContent = totalCount;
                    
                    const dailyCounts = {};
                    appointmentsArray.forEach(appointment => {
                        const date = appointment.preferredDate;
                        if (dailyCounts[date]) {
                            dailyCounts[date]++;
                        } else {
                            dailyCounts[date] = 1;
                        }
                    });
                    updateCalendar(dailyCounts);
                }

                function highlightSelectedDate(dateString) {
                    const previouslySelected = document.querySelector('.calendar-cell.selected-day');
                    if (previouslySelected) {
                        previouslySelected.classList.remove('selected-day');
                    }
                    if (dateString) {
                        const dayCell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
                        if (dayCell) {
                            dayCell.classList.add('selected-day');
                        }
                    }
                }

                function generateCalendar(year, month) {
                    const calendarGridEl = document.getElementById('calendarGrid');
                    const currentMonthYearEl = document.getElementById('currentMonthYear');
                    const firstDay = (new Date(year, month)).getDay();
                    const daysInMonth = 32 - new Date(year, month, 32).getDate();
                    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

                    currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

                    while (calendarGridEl.children.length > 7) {
                        calendarGridEl.removeChild(calendarGridEl.lastChild);
                    }
                    
                    for (let i = 0; i < firstDay; i++) {
                        const blankCell = document.createElement('div');
                        blankCell.className = "calendar-cell";
                        calendarGridEl.appendChild(blankCell);
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayCell = document.createElement('div');
                        const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dayCell.className = `calendar-cell calendar-day p-2`;
                        dayCell.innerHTML = `<span>${day}</span>`;
                        dayCell.setAttribute('data-date', formattedDate);
                        
                        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            dayCell.classList.add('current-day');
                        }
                        calendarGridEl.appendChild(dayCell);
                    }
                }
                
                function updateCalendar(dailyCounts) {
                    const calendarDays = document.querySelectorAll('.calendar-day');
                    calendarDays.forEach(dayCell => {
                        const date = dayCell.getAttribute('data-date');
                        const count = dailyCounts[date] || 0;
                        const existingCount = dayCell.querySelector('.calendar-count');
                        if (existingCount) existingCount.remove();
                        if (count > 0) {
                            dayCell.classList.add('has-appointments');
                            const countEl = document.createElement('div');
                            countEl.className = 'calendar-count';
                            countEl.textContent = count;
                            dayCell.appendChild(countEl);
                        } else {
                            dayCell.classList.remove('has-appointments');
                        }
                    });
                }

                function renderTable(data, duplicateKeys = []) {
                    const appointmentsTableBody = document.getElementById('appointmentsTableBody');
                    appointmentsTableBody.innerHTML = '';
                    
                    if (!data || Object.keys(data).length === 0) {
                        const noDataRow = document.createElement('tr');
                        noDataRow.innerHTML = `<td colspan="15" class="px-5 py-5 text-center text-gray-500">No appointments found.</td>`;
                        appointmentsTableBody.appendChild(noDataRow);
                        return;
                    }
                    
                    const appointmentsArray = Object.entries(data);
                    
                    appointmentsArray.forEach(([key, appointment]) => {
                        const row = document.createElement('tr');
                        let rowClasses = 'hover:bg-gray-50';
                        if (duplicateKeys.includes(key)) {
                            rowClasses += ' bg-red-50';
                        }
                        row.className = rowClasses;

                        const status = appointment.status || 'Scheduled';
                        let statusColor = 'text-yellow-600 font-semibold';
                        let actionButtons = '';
                        
                        if (status === 'Approved') {
                            statusColor = 'text-green-600 font-semibold';
                            actionButtons = `<button data-key="${key}" data-action="disapprove" class="disapprove-btn bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 transition duration-150 ease-in-out">Disapprove</button>`;
                        } else if (status === 'Declined') {
                            statusColor = 'text-red-600 font-semibold';
                            actionButtons = `<button data-key="${key}" data-action="approve" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-600 transition duration-150 ease-in-out">Approve</button>`;
                        } else {
                            statusColor = 'text-yellow-600 font-semibold';
                            actionButtons = `<button data-key="${key}" data-action="approve" class="approve-btn bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-600 transition duration-150 ease-in-out">Approve</button> <button data-key="${key}" data-action="decline" class="decline-btn bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 transition duration-150 ease-in-out ml-2">Decline</button>`;
                        }

                        row.innerHTML = `
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-center deletion-column"><input type="checkbox" class="appointment-checkbox" data-key="${key}"></td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.preferredDate}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.preferredTime}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.lastName || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.firstName || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.middleName || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.address || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.services || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.phone || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.email || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white">${appointment.specificDetails || 'N/A'}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white ${statusColor}">${status}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-right whitespace-nowrap">${actionButtons}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-center"><button data-key="${key}" class="edit-info-btn">Edit</button></td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-center deletion-column"><button data-key="${key}" data-action="delete" class="delete-row-btn bg-transparent border-none text-gray-500 hover:text-red-600 transition">🗑️</button></td>
                        `;
                        appointmentsTableBody.appendChild(row);
                    });
                }
                
                function checkForDuplicateAppointments(appointments) {
                    const timeSlots = {};
                    const duplicates = new Set();
                    Object.entries(appointments).forEach(([key, appointment]) => {
                        const dateTime = `${appointment.preferredDate}-${appointment.preferredTime}`;
                        if (timeSlots[dateTime]) {
                            duplicates.add(timeSlots[dateTime]);
                            duplicates.add(key);
                        } else {
                            timeSlots[dateTime] = key;
                        }
                    });
                    return Array.from(duplicates);
                }

                function filterAndRender() {
                    const query = document.getElementById('searchInput').value.toLowerCase();
                    const selectedDate = document.getElementById('dateInput').value;
                    const filteredBySearch = allAppointments.filter(([key, appointment]) => {
                        const status = appointment.status || 'Scheduled';
                        const matchesText = (
                            (appointment.firstName && appointment.firstName.toLowerCase().includes(query)) ||
                            (appointment.lastName && appointment.lastName.toLowerCase().includes(query)) ||
                            (appointment.middleName && appointment.middleName.toLowerCase().includes(query)) ||
                            (appointment.address && appointment.address.toLowerCase().includes(query)) ||
                            (appointment.services && appointment.services.toLowerCase().includes(query)) ||
                            (appointment.phone && appointment.phone.toLowerCase().includes(query)) ||
                            (appointment.email && appointment.email.toLowerCase().includes(query)) ||
                            (appointment.specificDetails && appointment.specificDetails.toLowerCase().includes(query)) ||
                            (status && status.toLowerCase().includes(query))
                        );
                        const matchesDate = !selectedDate || appointment.preferredDate === selectedDate;
                        return matchesText && matchesDate;
                    });

                    let finalData = {};
                    if (currentFilter === 'All') {
                        finalData = Object.fromEntries(filteredBySearch);
                    } else {
                        const filteredByStatus = filteredBySearch.filter(([key, appointment]) => (appointment.status || 'Scheduled') === currentFilter);
                        finalData = Object.fromEntries(filteredByStatus);
                    }
                    const duplicates = checkForDuplicateAppointments(Object.fromEntries(allAppointments));
                    const warningMessage = document.getElementById('doubleBookingWarning');
                    if (duplicates.length > 0) {
                        document.getElementById('warningText').textContent = `Multiple appointments are scheduled at the same time slots.`;
                        warningMessage.classList.remove('hidden');
                    } else {
                        warningMessage.classList.add('hidden');
                    }
                    renderTable(finalData, duplicates);
                }

                function updateDeleteButtonState() {
                    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                    const checkedCheckboxes = document.querySelectorAll('#appointmentsTableBody .appointment-checkbox:checked');
                    if (checkedCheckboxes.length > 0) {
                        deleteSelectedBtn.disabled = false;
                        deleteSelectedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        deleteSelectedBtn.disabled = true;
                        deleteSelectedBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        deleteSelectedBtn.textContent = 'Delete Selected';
                        clearTimeout(confirmTimeout);
                        confirmingButton = null;
                    }
                }

                // --- Start of executable code ---

                const appointmentsRef = ref(database, 'appointments/victoria');
                onValue(appointmentsRef, (snapshot) => {
                    const data = snapshot.val();
                    allAppointments = data ? Object.entries(data) : [];
                    updateCounts(data, currentYear, currentMonth);
                    filterAndRender();
                }, (error) => {
                    console.error("Error fetching data:", error);
                });

                // Initialize calendar
                currentYear = today.getFullYear();
                currentMonth = today.getMonth();
                generateCalendar(currentYear, currentMonth);
                
                // Set up all event listeners
                document.getElementById('searchInput').addEventListener('keyup', filterAndRender);
                document.getElementById('dateInput').addEventListener('change', () => {
                     const dateValue = document.getElementById('dateInput').value;
                     if (dateValue) {
                        const selectedDate = new Date(dateValue + 'T00:00:00Z');
                        currentYear = selectedDate.getUTCFullYear();
                        currentMonth = selectedDate.getUTCMonth();
                        generateCalendar(currentYear, currentMonth);
                        updateCounts(Object.fromEntries(allAppointments), currentYear, currentMonth);
                        highlightSelectedDate(dateValue);
                     } else {
                        highlightSelectedDate(null);
                     }
                     filterAndRender();
                });

                document.querySelectorAll('.filter-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            btn.classList.remove('active', 'bg-blue-600', 'text-white');
                            btn.classList.add('bg-gray-300', 'text-gray-700');
                        });
                        button.classList.add('active', 'bg-blue-600', 'text-white');
                        button.classList.remove('bg-gray-300', 'text-gray-700');
                        currentFilter = button.textContent;
                        filterAndRender();
                    });
                });
                
                document.getElementById('toggleDeletionBtn').addEventListener('click', () => {
                    document.body.classList.toggle('deletion-mode');
                    const isDeletionMode = document.body.classList.contains('deletion-mode');
                    const toggleBtn = document.getElementById('toggleDeletionBtn');
                    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

                    if (isDeletionMode) {
                        toggleBtn.textContent = 'Done';
                        toggleBtn.classList.remove('bg-red-500');
                        toggleBtn.classList.add('bg-gray-500');
                        deleteSelectedBtn.classList.remove('hidden');
                    } else {
                        toggleBtn.textContent = 'Manage Deletions';
                        toggleBtn.classList.remove('bg-gray-500');
                        toggleBtn.classList.add('bg-red-500');
                        deleteSelectedBtn.classList.add('hidden');
                        deleteSelectedBtn.disabled = true;
                        deleteSelectedBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        selectAllCheckbox.checked = false;
                        document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
                    }
                });

                document.getElementById('selectAllCheckbox').addEventListener('change', () => {
                    const isChecked = document.getElementById('selectAllCheckbox').checked;
                    document.querySelectorAll('#appointmentsTableBody .appointment-checkbox').forEach(cb => {
                        cb.checked = isChecked;
                    });
                    updateDeleteButtonState();
                });

                document.getElementById('appointmentsTableBody').addEventListener('change', (e) => {
                    if (e.target.classList.contains('appointment-checkbox')) {
                        updateDeleteButtonState();
                    }
                });

                document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
                    const deleteBtn = document.getElementById('deleteSelectedBtn');
                    if (deleteBtn.textContent === 'Confirm Delete?') {
                        const checkedCheckboxes = document.querySelectorAll('#appointmentsTableBody .appointment-checkbox:checked');
                        checkedCheckboxes.forEach(checkbox => {
                            const key = checkbox.getAttribute('data-key');
                            if (key) {
                                const appointmentRef = ref(database, `appointments/victoria/${key}`);
                                remove(appointmentRef).catch(error => {
                                    console.error(`Error deleting appointment ${key}:`, error);
                                });
                            }
                        });
                        
                        clearTimeout(confirmTimeout);
                        confirmingButton = null;
                        deleteBtn.textContent = 'Delete Selected';
                        updateDeleteButtonState();
                        document.getElementById('selectAllCheckbox').checked = false;

                    } else {
                        deleteBtn.textContent = 'Confirm Delete?';
                        confirmingButton = deleteBtn;
                        confirmTimeout = setTimeout(() => {
                            if (confirmingButton === deleteBtn) {
                                deleteBtn.textContent = 'Delete Selected';
                                confirmingButton = null;
                            }
                        }, 3000);
                    }
                });


                document.getElementById('appointmentsTableBody').addEventListener('click', (e) => {
                    const button = e.target;
                    const key = button.getAttribute('data-key');
                    const action = button.getAttribute('data-action');
                    
                    if (action) {
                         if (button.textContent === 'Confirm?') {
                            const appointmentRef = ref(database, `appointments/victoria/${key}`);
                            if (action === 'delete') {
                                remove(appointmentRef);
                            } else {
                                let newStatus = action === 'approve' ? 'Approved' : (action === 'decline' ? 'Declined' : 'Scheduled');
                                update(appointmentRef, { status: newStatus });
                            }
                            clearTimeout(confirmTimeout);
                            confirmingButton = null;
                        } else {
                            if(confirmingButton) {
                                const oldAction = confirmingButton.getAttribute('data-action');
                                confirmingButton.textContent = oldAction === 'delete' ? '🗑️' : oldAction.charAt(0).toUpperCase() + oldAction.slice(1);
                            }
                            button.textContent = 'Confirm?';
                            confirmingButton = button;
                            confirmTimeout = setTimeout(() => {
                                button.textContent = action === 'delete' ? '🗑️' : action.charAt(0).toUpperCase() + action.slice(1);
                                confirmingButton = null;
                            }, 3000);
                        }
                    }

                    if (button.classList.contains('edit-info-btn')) {
                        const appointment = allAppointments.find(([k]) => k === key)[1];
                        document.getElementById('editKey').value = key;
                        document.getElementById('editLastName').value = appointment.lastName;
                        document.getElementById('editFirstName').value = appointment.firstName;
                        document.getElementById('editMiddleName').value = appointment.middleName;
                        document.getElementById('editAddress').value = appointment.address;
                        document.getElementById('editService').value = appointment.services;
                        document.getElementById('editPhone').value = appointment.phone;
                        document.getElementById('editModal').classList.remove('hidden');
                    }
                });

                document.getElementById('viewServiceTotalsBtn').addEventListener('click', () => {
                    const serviceCounts = {};
                    allAppointments.forEach(([key, appointment]) => {
                        const appointmentDate = new Date(appointment.preferredDate);
                        if (appointment.status === 'Approved' && appointment.services && appointmentDate.getFullYear() === currentYear && appointmentDate.getMonth() === currentMonth) {
                            const serviceName = appointment.services;
                            serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
                        }
                    });

                    const serviceListContainer = document.getElementById('serviceListContainer');
                    const modalTitle = document.getElementById('serviceCountTitle');
                    const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });
                    
                    modalTitle.textContent = `Approved Service Totals for ${monthName} ${currentYear}`;
                    
                    let serviceListHtml = '';
                    if (Object.keys(serviceCounts).length > 0) {
                        for (const [service, count] of Object.entries(serviceCounts)) {
                            serviceListHtml += `
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <span class="text-sm font-medium text-gray-700">${service}</span>
                                    <span class="text-sm font-bold text-blue-600">${count}</span>
                                </div>
                            `;
                        }
                    } else {
                        serviceListHtml = `<p class="text-center text-gray-500">No approved appointments found for this month.</p>`;
                    }
                    
                    serviceListContainer.innerHTML = serviceListHtml;
                    document.getElementById('serviceCountModal').classList.remove('hidden');
                });

                document.getElementById('closeServiceCountModalBtn').addEventListener('click', () => {
                    document.getElementById('serviceCountModal').classList.add('hidden');
                });


                document.getElementById('closeEditModalBtn').addEventListener('click', () => document.getElementById('editModal').classList.add('hidden'));
                document.getElementById('saveEditBtn').addEventListener('click', () => {
                     const key = document.getElementById('editKey').value;
                     const updatedData = {
                        lastName: document.getElementById('editLastName').value,
                        firstName: document.getElementById('editFirstName').value,
                        middleName: document.getElementById('editMiddleName').value,
                        address: document.getElementById('editAddress').value,
                        services: document.getElementById('editService').value,
                        phone: document.getElementById('editPhone').value,
                    };
                    update(ref(database, `appointments/victoria/${key}`), updatedData).then(() => {
                        document.getElementById('editModal').classList.add('hidden');
                    });
                });
                
                document.getElementById('prevMonthBtn').addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                    generateCalendar(currentYear, currentMonth);
                    updateCounts(Object.fromEntries(allAppointments), currentYear, currentMonth);
                });
                 document.getElementById('nextMonthBtn').addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                    generateCalendar(currentYear, currentMonth);
                    updateCounts(Object.fromEntries(allAppointments), currentYear, currentMonth);
                });

                 document.getElementById('calendarGrid').addEventListener('click', (e) => {
                    const dayCell = e.target.closest('.calendar-day');
                    if (dayCell) {
                        const selectedDate = dayCell.getAttribute('data-date');
                        document.getElementById('dateInput').value = selectedDate;
                        highlightSelectedDate(selectedDate);
                        filterAndRender();
                    }
                });

                document.getElementById('printBtn').addEventListener('click', () => window.print());


            } else {
                // User is not signed in. Redirect them away.
                console.log("User is not authenticated. Redirecting to login page.");
                window.location.href = 'https://muntinlupacityhealthoffice.github.io/queue/preselection.html';
            }
        });
        
        // Trigger the authentication process on page load
        authenticateUser();

    </script>
</body>
</html>
