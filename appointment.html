<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Health Office - Set Appointment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom, #e0eaf3, #f0f4f8);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #ffd600;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .footer {
            background-color: #ffd600;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="privacyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-blue-900">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4 text-blue-800">Data Privacy Notice ðŸ‡µðŸ‡­</h3>
                <p class="text-gray-700 mb-6">
                    In compliance with the **Philippine Data Privacy Act of 2012 (RA 10173)**, we assure you that your personal information collected for this appointment is handled with the utmost care and security.
                </p>
                <p class="text-sm text-gray-600 mb-6">
                    Your data will be used solely for the purpose of processing your appointment and will not be shared with any unauthorized third parties. By proceeding, you consent to our privacy policy.
                </p>
                <button id="acknowledgePrivacy" class="w-full sm:w-auto px-6 py-2 bg-[#ffc107] text-gray-900 font-semibold rounded-full shadow-md hover:bg-[#ffa000] focus:outline-none focus:ring-2 focus:ring-[#ffc107] focus:ring-offset-2 transition-colors duration-200">
                    I Understand and Agree
                </button>
            </div>
        </div>
    </div>

    <header class="header border-b-4 border-blue-900">
        <div class="container flex flex-col sm:flex-row justify-center sm:justify-between items-center px-4 py-4">
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-6 text-center sm:text-left">
                <img src="pictures/CHO LOGO.png" alt="City Health Logo" class="rounded-full w-28 h-28 shadow-lg">
                <div>
                    <h1 class="font-semibold text-4xl text-yellow-600">MUNTINLUPA</h1>
                    <h2 class="font-bold text-2xl text-blue-800">CITY HEALTH OFFICE</h2>
                </div>
            </div>
            <nav class="mt-4 sm:mt-0">
                <ul class="flex space-x-6 font-medium">
                    <li><a href="index.html" class="hover:text-blue-800">HOME</a></li>
                    <li><a href="#" class="hover:text-blue-800">ABOUT</a></li>
                    <li><a href="#" class="hover:text-blue-800">SERVICES</a></li>
                    <li><a href="#" class="hover:text-blue-800">CONTACT</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="py-12 px-4">
        <div class="container">
            <h2 class="text-3xl font-bold text-center mb-8">Set Appointment</h2>
            
            <div id="formContainer" class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg border-2 border-blue-900">
                <div id="step1">
                    <h3 class="text-xl font-semibold mb-4 text-center">Step 1: Personal Information</h3>
                    <form id="personalInfoForm">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name*</label>
                                <input type="text" id="lastName" name="lastName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700">First Name*</label>
                                <input type="text" id="firstName" name="firstName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label for="middleName" class="block text-sm font-medium text-gray-700">Middle Name</label>
                                <input type="text" id="middleName" name="middleName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="age" class="block text-sm font-medium text-gray-700">Age*</label>
                                <input type="number" id="age" name="age" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                            <!-- Address Field -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex flex-col md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700">Address*</label>
                        <input type="text" id="permanent-address" name="permanentAddress" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
                            <div>
                                <label for="sex" class="block text-sm font-medium text-gray-700">Sex*</label>
                                <select id="sex" name="sex" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="">--SELECT--</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Email*</label>
                                <input type="email" id="email" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number*</label>
                                <input type="tel" id="phone" name="phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                            <div>
                                <label for="services" class="block text-sm font-medium text-gray-700">Services*</label>
                                <select id="services" name="services" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="">--SELECT--</option>
                                    <option value="death_cert/transfer_exhumation">Issuance and release of Death certificates, Transfer certificates or Authorization of exhumation remains</option>
                                    <option value="water_laboratory">Water Laboratory</option>
                                    <option value="checkup">General Consultation</option>
                                    <option value="medical_certificate">Issuance of medical Certificate</option>
                                    <option value="sanitary_permit">Issuance of Sanitary Permit</option>
                                    <option value="laboratory">Laboratory</option>
                                    <option value="x-ray">x-ray</option>
                                    <option value="vaccination_adults">Vaccination (Adults)</option>
                                    <option value="vaccination_babies">Vaccination (Babies)</option>
                                    <option value="vaccination_rabies">Vaccination (Rabies)</option>
                                    <option value="dental">Dental</option>
                                    <option value="others">Others</option>
                                </select>
                            </div>
                            <div>
                                <label for="healthCenter" class="block text-sm font-medium text-gray-700">Health Center*</label>
                                <select id="healthCenter" name="healthCenter" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <option value="">--SELECT--</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="specificDetails" class="block text-sm font-medium text-gray-700">Specific Details*</label>
                            <textarea id="specificDetails" name="specificDetails" rows="4" required placeholder="e.g., Please describe your symptoms or the reason for your appointment in detail." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" id="nextButton" class="w-full sm:w-auto px-6 py-2 bg-[#ffc107] text-gray-900 font-semibold rounded-full shadow-md hover:bg-[#ffa000] focus:outline-none focus:ring-2 focus:ring-[#ffc107] focus:ring-offset-2 transition-colors duration-200">Next</button>
                        </div>
                    </form>
                </div>
                
                <div id="step2" class="hidden">
                    <h3 class="text-xl font-semibold mb-4 text-center">Step 2: Schedule Appointment</h3>
                    <form id="scheduleForm">
                        <div class="mb-4">
                            <label for="preferredDate" class="block text-sm font-medium text-gray-700">Preferred Date*</label>
                            <input type="date" id="preferredDate" name="preferredDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div class="mb-6">
                            <label for="preferredTime" class="block text-sm font-medium text-gray-700">Preferred Time*</label>
                            <select id="preferredTime" name="preferredTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">--SELECT--</option>
                            </select>
                            <span id="availabilityMessage" class="text-sm mt-1"></span>
                        </div>
                        <div class="flex justify-between">
                            <button type="button" id="backButton" class="w-full sm:w-auto px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition-colors duration-200">Back</button>
                            <button type="submit" id="submitButton" class="flex items-center justify-center w-full sm:w-auto px-6 py-2 bg-gray-400 text-gray-600 font-semibold rounded-full shadow-md transition-colors duration-200" disabled>
                                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-blue-400">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">Confirm Your Appointment</h3>
                        <p class="text-gray-600 mb-6">Please review the details below before confirming.</p>
                        
                        <div id="confirmationDetails" class="text-left text-gray-800 space-y-2 mb-6 p-4 rounded-md bg-gray-50 border border-gray-200">
                        </div>

                        <div class="text-center bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="text-sm text-gray-700 font-semibold">Important</p>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">Please take a screenshot or photo of this confirmation page for your records.</p>
                        </div>
                        
                        <div class="flex justify-around space-x-4">
                            <button id="editButton" class="w-full px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition-colors duration-200">
                                Edit
                            </button>
                            <button id="confirmButton" class="w-full px-4 py-2 bg-[#ffc107] text-gray-900 font-semibold rounded-full shadow-md hover:bg-[#ffa000] focus:outline-none focus:ring-2 focus:ring-[#ffc107] focus:ring-offset-2 transition-colors duration-200">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="successMessage" class="hidden fixed inset-0 bg-green-500 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-green-400">
                    <div class="text-center">
                        <svg class="mx-auto h-16 w-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-2xl font-bold text-green-700 mt-4">Appointment Pending</h3>
                        <p class="text-gray-600 mt-2">Your appointment has been successfully submitted. You are currently in line at:</p>
                        <p class="mt-4 text-3xl font-bold text-blue-800" id="queueNumberDisplay"></p>
                        <p class="mt-2 text-sm text-gray-600">A representative will confirm your appointment via email or phone call as soon as possible.</p>
                        <div class="mt-6">
                            <button onclick="window.location.reload();" class="w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="footer mt-12">
        <div class="container text-center text-gray-800 font-medium">
            MUNTINLUPA CITY HEALTH OFFICE
        </div>
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoBZyS0BKZe1MMG78WpiK9tFQAZBd-wKg",
            authDomain: "cho-clinic.firebaseapp.com",
            databaseURL: "https://cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cho-clinic",
            storageBucket: "cho-clinic.firebasestorage.app",
            messagingSenderId: "1078609107976",
            appId: "1:1078609107976:web:11cfb6afccf463fc17c5bd",
            measurementId: "G-FHE4TNMD0X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // All health centers and their display names with associated services
       const healthCenterData = {
            "city_health_office": { name: "CITY HEALTH OFFICE", services: ["death_cert/transfer_exhumation", "water_laboratory", "medical_certificate", "sanitary_permit", "others"] },
            "tunasan": { name: "TUNASAN HEALTH CENTER", services: ["checkup", "medical_certificate", "laboratory", "dental", "others"] },
            "victoria": { name: "VICTORIA HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "dental", "others"] },
            "laguerta": { name: "LAGUERTA HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "laboratory", "vaccination_adults", "vaccination_babies", "others"] },
            "poblacion": { name: "POBLACION HEALTH CENTER", services: ["checkup", "medical_certificate", "laboratory", "vaccination_adults", "vaccination_babies", "vaccination_rabies", "dental", "others"] },
            "southville": { name: "SOUTHVILLE HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "vaccination_adults", "vaccination_babies", "vaccination_rabies", "laboratory", "others"] },
            "putatan": { name: "PUTATAN HEALTH CENTER", services: ["checkup", "medical_certificate", "sanitary_permit", "dental", "laboratory", "x-ray", "vaccination_adults", "vaccination_babies", "others"] },
            "putatan_annex": { name: "PUTATAN ANNEX HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "vaccination_rabies", "laboratory", "dental", "others"] },
            "lakeview": { name: "LAKEVIEW HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "dental", "others"] },
            "bayan_main": { name: "BAYANAN MAIN HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "laboratory", "dental", "others"] },
            "bayanan_annex": { name: "BAYANAN ANNEX HEALTH CENTER", services: ["checkup", "vaccination_adults", "vaccination_babies", "dental", "laboratory", "others"] },
            "alabang": { name: "ALABANG HEALTH CENTER", services: ["checkup", "medical_certificate", "sanitary_permit", "dental", "laboratory", "vaccination_adults", "vaccination_babies", "vaccination_rabies", "others"] },
            "ayala_alabang": { name: "AYALA ALABANG HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "cupang": { name: "CUPANG HEALTH CENTER", services: ["checkup", "laboratory", "medical_certificate", "vaccination_adults", "vaccination_babies", "vaccination_rabies", "dental", "others"] },
            "sitio_sto_nino": { name: "SITIO STO. NINO HEALTH CENTER", services: ["checkup", "medical_certificate", "others"] },
            "buli": { name: "BULI HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "dental", "others"] },
            "sucat": { name: "SUCAT HEALTH CENTER", services: ["checkup", "vaccination_adults", "vaccination_babies", "laboratory", "medical_certificate", "dental", "others"] },
            "bagong_silang": { name: "BAGONG SILANG HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination_adults", "vaccination_babies", "others", "dental"] }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const servicesSelect = document.getElementById('services');
            const healthCenterSelect = document.getElementById('healthCenter');
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const personalInfoForm = document.getElementById('personalInfoForm');
            const scheduleForm = document.getElementById('scheduleForm');
            const preferredDateInput = document.getElementById('preferredDate');
            const preferredTimeSelect = document.getElementById('preferredTime');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationDetails = document.getElementById('confirmationDetails');
            const editButton = document.getElementById('editButton');
            const confirmButton = document.getElementById('confirmButton');
            const successMessage = document.getElementById('successMessage');
            const formContainer = document.getElementById('formContainer');
            const availabilityMessage = document.getElementById('availabilityMessage');
            const submitButton = document.getElementById('submitButton');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Privacy modal elements
            const privacyModal = document.getElementById('privacyModal');
            const acknowledgePrivacyButton = document.getElementById('acknowledgePrivacy');

            // Function to set the minimum date to tomorrow
            const setMinDate = () => {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const year = tomorrow.getFullYear();
                const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const day = String(tomorrow.getDate()).padStart(2, '0');
                
                preferredDateInput.setAttribute('min', `${year}-${month}-${day}`);
            };

            // Function to generate time slots
            const generateTimeSlots = () => {
                preferredTimeSelect.innerHTML = '<option value="">--SELECT--</option>';
                const startTime = 8 * 60; // 8:00 AM in minutes
                const endTime = 17 * 60; // 5:00 PM in minutes
                const slotDuration = 30; // 30 minutes

                let currentTime = startTime;
                while (currentTime <= endTime) {
                    const hours = Math.floor(currentTime / 60);
                    const minutes = currentTime % 60;
                    
                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    const timeString = `${formattedHours}:${formattedMinutes}`;
                    
                    const option = document.createElement('option');
                    option.value = timeString;
                    option.textContent = timeString;
                    preferredTimeSelect.appendChild(option);
                    
                    currentTime += slotDuration;
                }
            };
            
            // Function to filter health centers based on selected service
            const filterHealthCentersByService = () => {
                const selectedService = servicesSelect.value;
                healthCenterSelect.innerHTML = '<option value="">--SELECT--</option>';
                
                if (selectedService) {
                    for (const key in healthCenterData) {
                        if (healthCenterData[key].services.includes(selectedService)) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = healthCenterData[key].name;
                            healthCenterSelect.appendChild(option);
                        }
                    }
                }
            };

            // This function checks for availability and enables/disables the submit button.
            const checkAvailability = () => {
                const healthCenter = healthCenterSelect.value;
                const date = preferredDateInput.value;
                const time = preferredTimeSelect.value;
                
                console.log('Checking availability for:', {
                    healthCenter: healthCenter || 'Not Selected',
                    date: date || 'Not Selected',
                    time: time || 'Not Selected'
                });
                
                // Reset availability message and button state
                availabilityMessage.textContent = '';
                submitButton.disabled = true;
                submitButton.classList.remove('bg-[#ffc107]', 'text-gray-900', 'hover:bg-[#ffa000]', 'focus:ring-[#ffc107]', 'focus:ring-offset-2');
                submitButton.classList.add('bg-gray-400', 'text-gray-600');
                loadingSpinner.classList.add('hidden');


                if (!healthCenter || !date || !time) {
                    console.log('One or more required fields are empty. Button remains disabled.');
                    return;
                }

                // Show loading spinner while checking
                loadingSpinner.classList.remove('hidden');

                const healthCenterRef = ref(database, `appointments/${healthCenter}`);
                onValue(healthCenterRef, (snapshot) => {
                    loadingSpinner.classList.add('hidden');
                    const data = snapshot.val();
                    let isBooked = false;
                    if (data) {
                        for (const key in data) {
                            if (data[key].preferredDate === date && data[key].preferredTime === time) {
                                isBooked = true;
                                break;
                            }
                        }
                    }

                    if (isBooked) {
                        availabilityMessage.textContent = 'This time slot is already booked. Please choose another one.';
                        availabilityMessage.className = 'text-sm mt-1 text-red-500 font-semibold';
                    } else {
                        availabilityMessage.textContent = 'This time slot is available.';
                        availabilityMessage.className = 'text-sm mt-1 text-green-600 font-semibold';
                        // This is the line that enables the button!
                        submitButton.disabled = false;
                        submitButton.classList.remove('bg-gray-400', 'text-gray-600');
                        submitButton.classList.add('bg-[#ffc107]', 'text-gray-900', 'hover:bg-[#ffa000]', 'focus:ring-[#ffc107]', 'focus:ring-offset-2');
                    }
                }, { onlyOnce: true });
            };

            // Initial setup
            setMinDate();
            generateTimeSlots();
            privacyModal.classList.remove('hidden');

            // Handle privacy acknowledgment
            acknowledgePrivacyButton.addEventListener('click', () => {
                privacyModal.classList.add('hidden');
            });

            // Listen for changes on the service select to filter health centers
            servicesSelect.addEventListener('change', () => {
                filterHealthCentersByService();
                checkAvailability();
            });

            // Listen for changes on the time, date, and health center inputs
            preferredDateInput.addEventListener('change', checkAvailability);
            preferredTimeSelect.addEventListener('change', checkAvailability);
            healthCenterSelect.addEventListener('change', checkAvailability);

            // Handle "Next" button click
            nextButton.addEventListener('click', (event) => {
                if (personalInfoForm.checkValidity()) {
                    event.preventDefault();
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                    checkAvailability(); // Initial check when moving to step 2
                } else {
                    personalInfoForm.reportValidity();
                }
            });

            // Handle "Back" button click
            backButton.addEventListener('click', () => {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });

            // Handle "Submit" button click (shows confirmation modal)
            scheduleForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (scheduleForm.checkValidity()) {
                    // Collect all form data
                    const personalData = new FormData(personalInfoForm);
                    const scheduleData = new FormData(scheduleForm);
                    const allData = {};

                    personalData.forEach((value, key) => allData[key] = value);
                    scheduleData.forEach((value, key) => allData[key] = value);

                    // Populate confirmation modal with details
                    const selectedHealthCenter = healthCenterData[allData.healthCenter].name;
                    const selectedService = servicesSelect.options[servicesSelect.selectedIndex].text;
                    confirmationDetails.innerHTML = `
                        <p><strong class="font-semibold">Full Name:</strong> ${allData.firstName} ${allData.middleName} ${allData.lastName}</p>
                        <p><strong class="font-semibold">Age:</strong> ${allData.age}</p>
                        <p><strong class="font-semibold">Sex:</strong> ${allData.sex}</p>
                        <p><strong class="font-semibold">Email:</strong> ${allData.email}</p>
                        <p><strong class="font-semibold">Phone:</strong> ${allData.phone}</p>
                        <p><strong class="font-semibold">Service:</strong> ${selectedService}</p>
                        <p><strong class="font-semibold">Health Center:</strong> ${selectedHealthCenter}</p>
                        <p><strong class="font-semibold">Preferred Date:</strong> ${allData.preferredDate}</p>
                        <p><strong class="font-semibold">Preferred Time:</strong> ${allData.preferredTime}</p>
                        <p><strong class="font-semibold">Details:</strong> ${allData.specificDetails}</p>
                    `;
                    
                    confirmationModal.classList.remove('hidden');
                    formContainer.classList.add('hidden');
                }
            });

            // Handle "Edit" button click in modal
            editButton.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                formContainer.classList.remove('hidden');
            });

            // Handle "Confirm" button click in modal
            confirmButton.addEventListener('click', () => {
                // Submit data to Firebase
                const personalData = new FormData(personalInfoForm);
                const scheduleData = new FormData(scheduleForm);
                const allData = {};
                personalData.forEach((value, key) => allData[key] = value);
                scheduleData.forEach((value, key) => allData[key] = value);

                const healthCenterKey = allData.healthCenter;
                const appointmentsRef = ref(database, `appointments/${healthCenterKey}`);

                push(appointmentsRef, {
                    ...allData,
                    timestamp: new Date().toISOString()
                }).then(() => {
                    console.log("Appointment submitted successfully!");
                    confirmationModal.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    // Fetch the latest count for the queue number
                    onValue(appointmentsRef, (snapshot) => {
                        const count = snapshot.size;
                        document.getElementById('queueNumberDisplay').textContent = count;
                    }, { onlyOnce: true });
                }).catch((error) => {
                    console.error("Error submitting appointment: ", error);
                    alert("There was an error submitting your appointment. Please try again.");
                });
            });
        });
    </script>
</body>
</html>
